Description: Security backport of CVE-2022-22707
  From: povcfe <povcfe@qq.com>
  Date: Wed, 5 Jan 2022 11:11:09 +0000
  Subject: [PATCH] [mod_extforward] fix out-of-bounds (OOB) write (fixes #3134)

  There is a potential remote denial of service in lighttpd mod_extforward
  under specific, non-default and uncommon 32-bit lighttpd mod_extforward
  configurations.

Origin: upstream, https://github.com/lighttpd/lighttpd1.4/commit/8c62a890e23f5853b1a562b03fe3e1bccc6e7664
Bug: https://redmine.lighttpd.net/issues/3134
Bug: https://nvd.nist.gov/vuln/detail/CVE-2022-22707

Reviewed-by: Jack Fewx <jack@fewx.com>
Bug-Ubuntu: https://bugs.launchpad.net/bugs/1994989

---
--- lighttpd-1.4.55.orig/src/mod_extforward.c
+++ lighttpd-1.4.55/src/mod_extforward.c
@@ -673,7 +673,7 @@ static handler_t mod_extforward_Forwarde
         while (s[i] == ' ' || s[i] == '\t') ++i;
         if (s[i] == ';') { ++i; continue; }
         if (s[i] == ',') {
-            if (j >= (int)(sizeof(offsets)/sizeof(int))) break;
+            if (j >= (int)(sizeof(offsets)/sizeof(int))-1) break;
             offsets[++j] = -1; /*("offset" separating params from next proxy)*/
             ++i;
             continue;
